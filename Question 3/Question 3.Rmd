---
title: "Question 3"
documentclass: elsarticle
Thesis_FP: no
output:
  pdf_document:
    keep_tex: yes
    template: Tex/TexDefault.txt
    fig_width: null
    fig_height: 3.5
  html_document:
    df_print: paged
Author1: Ronan Morris
Ref1: Stellenbosch University
Email1: 22876634\\@sun.ac.za
BottomRFooter: \footnotesize Page \thepage
addtoprule: yes
addfootrule: yes
margin: 2.3
bottom: 2
top: 2.5
HardSet_layout: yes
linenumbers: no
bibliography: Tex/ref.bib
csl: "Tex/harvard-stellenbosch-university.csl"
RemovePreprintSubmittedTo: yes
toc: no
numbersections: yes
fontsize: 11pt
linestretch: 1.2
link-citations: yes
AddTitle: yes
---
```{r setup, include=FALSE}

rm(list = ls())

tinytex::install_tinytex(force = TRUE)
options(repos = "https://cran.mirror.ac.za/")

gc() 

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.width = 6, fig.height = 5, fig.pos="H", fig.pos = 'H')

if(!require("tidyverse")) install.packages("tidyverse")

rm(list = ls())

# Loading in data

ALSI <- read_rds("data/ALSI.rds")

RebDays <- read_rds("data/Rebalance_days.rds") %>% 
    filter(date >= first(ALSI$date) & 
               Date_Type == "Effective Date" &
               date <= last(ALSI$date))

pacman::p_load(tbl2xts, PerformanceAnalytics)

library(tidyverse)
library(fmxdat)
library(RcppRoll)
library(gridExtra)

###

source('code/PortReturn.R')

source('code/Proportional_Cap_Foo.R') # Nico function

```

```{r Volatility periods in Rand}

# Simply want to find high volatility years for the ZAR and add them to the ggplots later. I have chosen not to stratify; time pressure is a factor but also, I think that the graph at the end of this will be pretty neat. 

ZAR <- read_rds("data/Monthly_zar.rds") %>%
    select(-Tickers) %>% 
    mutate(Return = value/lag(value) - 1) %>% 
    filter(date >= first(ALSI$date)) %>% 
    select(-c(value)) %>% 
    na.omit()

ZARSD <- ZAR %>% 
  
  mutate(Year = format(date, "%Y")) %>% 
  
  group_by(Year) %>% summarise(SD = sd(Return)*sqrt(12)) %>% 
  
  mutate(TopQtile = quantile(SD, 0.67),
         
         BotQtile = quantile(SD, 0.33))

Hi_Vol <- ZARSD %>% filter(SD > TopQtile) %>% pull(Year)

# 2016, 2018, 2020, and 2023 are high volatility years. 

Low_Vol <- ZARSD %>% filter(SD < BotQtile) %>% pull(Year)

# 2014, 2015, 2017, 2021 are low volatility years. 

```

```{r Portfolio Returns}

# Eventhough I only use it once, i decided that a PortReturn function would be best suited to this question because of how many times it had to be rerun and edited. Essentially, a function that takes a data set and performs large parts of the portfolio returns process outlined in the practical about portfolio creation and returns. 

Indexes <- ALSI %>%  pull(Index_Name) %>% na.omit(.) %>%  unique()

IndRet <- list()

# I want to estimate rolling returns instead, because I think for such similar funds, this will allow us to see a fair representation of their returns. 

for(i in 1:length(Indexes)){
    
    # use the PortReturn() function:
 
    IndRet[[i]] <- PortReturn(ALSI,index = Indexes[i]) %>% 
        group_by(Methodod) %>% 
    mutate(RollRets = RcppRoll::roll_prod(1 + Returns, 
                                          36, 
                                          fill = NA, 
                                          align = "right")^(12/36) - 1) %>%   
    group_by(date) %>%   
    filter(any(!is.na(RollRets))) %>%
    mutate(Index = Indexes[i])
}

names(IndRet) <- Indexes

indices_roll_ret <- rbind(IndRet[[1]],
                          IndRet[[2]], 
                          IndRet[[3]]) %>% 
    arrange(date)
    
### Make Plots

    # Earlier, I created the vectors of high volatility and low volatility dates of the rand. These will now be used to construct ranges that can further be used in a ggplot object to create shaded regions of high volatility and low volatility. 

# Ranges: 

   # High Vol

HV1 <- data.frame(
  xmin = as.Date("2016-01-01"),
  xmax = as.Date("2016-12-01"),
  ymin = -Inf,
  ymax = Inf
)

HV2 <- data.frame(
  xmin = as.Date("2018-01-01"),
  xmax = as.Date("2018-12-01"),
  ymin = -Inf,
  ymax = Inf
)

HV3 <- data.frame(
  xmin = as.Date("2020-01-01"),
  xmax = as.Date("2020-12-01"),
  ymin = -Inf,
  ymax = Inf
)

HV4 <- data.frame(
  xmin = as.Date("2023-01-01"),
  xmax = as.Date("2023-12-01"),
  ymin = -Inf,
  ymax = Inf
)

# Low vol 

LV1 <- data.frame(
  xmin = as.Date("2014-01-01"),
  xmax = as.Date("2014-12-01"),
  ymin = -Inf,
  ymax = Inf
)

LV2 <- data.frame(
  xmin = as.Date("2015-01-01"),
  xmax = as.Date("2015-12-01"),
  ymin = -Inf,
  ymax = Inf
)

LV3 <- data.frame(
  xmin = as.Date("2017-01-01"),
  xmax = as.Date("2017-12-01"),
  ymin = -Inf,
  ymax = Inf
)

LV4 <- data.frame(
  xmin = as.Date("2021-01-01"),
  xmax = as.Date("2021-12-01"),
  ymin = -Inf,
  ymax = Inf
)

###

alpha = 0.2

```

```{r Making ggplots}

# I should have made a function.

# Large cap stocks

Large <- indices_roll_ret %>% 
     filter(Index == "Large_Caps") %>% 
        ggplot() +
    geom_rect(data = HV1, 
              aes(xmin = xmin, 
                  xmax = xmax, 
                  ymin = ymin, 
                  ymax = ymax), 
              fill = "red4", 
              alpha = alpha) +
    geom_rect(data = HV2, 
              aes(xmin = xmin, 
                  xmax = xmax, 
                  ymin = ymin, 
                  ymax = ymax), 
              fill = "red4", 
              alpha = alpha) +
    geom_rect(data = HV3, 
              aes(xmin = xmin, 
                  xmax = xmax, 
                  ymin = ymin, 
                  ymax = ymax), 
              fill = "red4", 
              alpha = alpha) +
    geom_rect(data = HV4, 
              aes(xmin = xmin, 
                  xmax = xmax, 
                  ymin = ymin, 
                  ymax = ymax), 
              fill = "red4", 
              alpha = alpha) +
    geom_rect(data = LV1, 
              aes(xmin = xmin, 
                  xmax = xmax, 
                  ymin = ymin, 
                  ymax = ymax), 
              fill = "green4", 
              alpha = alpha) +
    geom_rect(data = LV2, 
              aes(xmin = xmin, 
                  xmax = xmax, 
                  ymin = ymin, 
                  ymax = ymax), 
              fill = "green4", 
              alpha = alpha) +
    geom_rect(data = LV3, 
              aes(xmin = xmin, 
                  xmax = xmax, 
                  ymin = ymin, 
                  ymax = ymax), 
              fill = "green4", 
              alpha = alpha) +
    geom_rect(data = LV4, 
              aes(xmin = xmin, 
                  xmax = xmax, 
                  ymin = ymin, 
                  ymax = ymax), 
              fill = "green4", 
              alpha = alpha) +
    geom_line(aes(date, RollRets, colour = Methodod), 
                  alpha = 0.8,
                  size = 1) + 
     fmxdat::fmx_cols() + 
        labs(title = "Large Cap Shares", 
             y = "",
             x = "") +
        theme_classic()

###

# Mid cap stocks

Mid <- indices_roll_ret %>% 
     filter(Index == "Mid_Caps") %>% 
        ggplot() +
    geom_rect(data = HV1, 
              aes(xmin = xmin, 
                  xmax = xmax, 
                  ymin = ymin, 
                  ymax = ymax), 
              fill = "red4", 
              alpha = alpha) +
    geom_rect(data = HV2, 
              aes(xmin = xmin, 
                  xmax = xmax, 
                  ymin = ymin, 
                  ymax = ymax), 
              fill = "red4", 
              alpha = alpha) +
    geom_rect(data = HV3, 
              aes(xmin = xmin, 
                  xmax = xmax, 
                  ymin = ymin, 
                  ymax = ymax), 
              fill = "red4", 
              alpha = alpha) +
    geom_rect(data = HV4, 
              aes(xmin = xmin, 
                  xmax = xmax, 
                  ymin = ymin, 
                  ymax = ymax), 
              fill = "red4", 
              alpha = alpha) +
    geom_rect(data = LV1, 
              aes(xmin = xmin, 
                  xmax = xmax, 
                  ymin = ymin, 
                  ymax = ymax), 
              fill = "green4", 
              alpha = alpha) +
    geom_rect(data = LV2, 
              aes(xmin = xmin, 
                  xmax = xmax, 
                  ymin = ymin, 
                  ymax = ymax), 
              fill = "green4", 
              alpha = alpha) +
    geom_rect(data = LV3, 
              aes(xmin = xmin, 
                  xmax = xmax, 
                  ymin = ymin, 
                  ymax = ymax), 
              fill = "green4", 
              alpha = alpha) +
    geom_rect(data = LV4, 
              aes(xmin = xmin, 
                  xmax = xmax, 
                  ymin = ymin, 
                  ymax = ymax), 
              fill = "green4", 
              alpha = alpha) +
    geom_line(aes(date, RollRets, colour = Methodod), 
                  alpha = 0.8,
                  size = 1) + 
     fmxdat::fmx_cols() + 
        labs(title = "Mid Cap Shares", 
             y = "",
             x = "") +
        theme_classic()

###

# Small Cap shares 

Small <- indices_roll_ret %>% 
     filter(Index == "Small_Caps") %>% 
        ggplot() +
    geom_rect(data = HV1, 
              aes(xmin = xmin, 
                  xmax = xmax, 
                  ymin = ymin, 
                  ymax = ymax), 
              fill = "red4", 
              alpha = alpha) +
    geom_rect(data = HV2, 
              aes(xmin = xmin, 
                  xmax = xmax, 
                  ymin = ymin, 
                  ymax = ymax), 
              fill = "red4", 
              alpha = alpha) +
    geom_rect(data = HV3, 
              aes(xmin = xmin, 
                  xmax = xmax, 
                  ymin = ymin, 
                  ymax = ymax), 
              fill = "red4", 
              alpha = alpha) +
    geom_rect(data = HV4, 
              aes(xmin = xmin, 
                  xmax = xmax, 
                  ymin = ymin, 
                  ymax = ymax), 
              fill = "red4", 
              alpha = alpha) +
    geom_rect(data = LV1, 
              aes(xmin = xmin, 
                  xmax = xmax, 
                  ymin = ymin, 
                  ymax = ymax), 
              fill = "green4", 
              alpha = alpha) +
    geom_rect(data = LV2, 
              aes(xmin = xmin, 
                  xmax = xmax, 
                  ymin = ymin, 
                  ymax = ymax), 
              fill = "green4", 
              alpha = alpha) +
    geom_rect(data = LV3, 
              aes(xmin = xmin, 
                  xmax = xmax, 
                  ymin = ymin, 
                  ymax = ymax), 
              fill = "green4", 
              alpha = alpha) +
    geom_rect(data = LV4, 
              aes(xmin = xmin, 
                  xmax = xmax, 
                  ymin = ymin, 
                  ymax = ymax), 
              fill = "green4", 
              alpha = alpha) +
    geom_line(aes(date, RollRets, colour = Methodod), 
                  alpha = 0.8,
                  size = 1) + 
     fmxdat::fmx_cols() + 
        labs(title = "Small Cap Shares", 
             y = "",
             x = "") +
        theme_classic()

```

```{r ,  warning =  FALSE, fig.align = 'center', fig.cap = "Large Cap Stocks \\label{Figure3.1}", fig.ext = 'png', fig.height = 3, fig.width = 6}

finplot(Large, 
        x.date.dist = "1 year", 
        x.date.type = "%Y", 
        x.vert = T, 
        y.pct = T, 
        y.pct_acc = 1)

```

```{r ,  warning =  FALSE, fig.align = 'center', fig.cap = "Mid Cap Stocks \\label{Figure3.2}", fig.ext = 'png', fig.height = 3, fig.width = 6}

finplot(Mid, 
        x.date.dist = "1 year", 
        x.date.type = "%Y", 
        x.vert = T, 
        y.pct = T, 
        y.pct_acc = 1)

```

```{r ,  warning =  FALSE, fig.align = 'center', fig.cap = "Small Cap Stocks \\label{Figure3.3}", fig.ext = 'png', fig.height = 3, fig.width = 6}

finplot(Small, 
        x.date.dist = "1 year", 
        x.date.type = "%Y", 
        x.vert = T, 
        y.pct = T, 
        y.pct_acc = 1)

```

```{r Capped Portfolio}

rebALSI <- ALSI %>% 
filter(date %in% RebDays$date) %>% 
mutate(RebalanceTime = format(date, "%Y%B")) %>% 
    select(date, Tickers, Return, J203, RebalanceTime) %>% 
    rename(weight = J203) %>% 
    mutate(weight = coalesce(weight , 0))
  
Capped <- rebALSI %>% 
    group_split(RebalanceTime) %>% 
    map_df(~Proportional_Cap_Foo(., W_Cap = 0.1) ) %>% 
    select(-RebalanceTime)
 
ALSI_wts <- Capped %>% 
    tbl_xts(cols_to_xts = weight, 
            spread_by = Tickers)

ALSI_rts <- ALSI %>% 
    filter(Tickers %in% unique(Capped$Tickers)) %>% 
    tbl_xts(cols_to_xts = Return, 
            spread_by = Tickers)

ALSI_wts[is.na(ALSI_wts)] <- 0

ALSI_rts[is.na(ALSI_rts)] <- 0

ALSICapped <- rmsfuns::Safe_Return.portfolio(R = ALSI_rts, 
                                             weights = ALSI_wts, 
                                             lag_weights = T) %>% 
    xts_tbl() %>% 
    rename(ALSI = portfolio.returns)

# Capped Portfolio - SWIX

RebSWIX <- ALSI %>% 
filter(date %in% RebDays$date) %>% 
mutate(RebalanceTime = format(date, "%Y%B")) %>% 
    select(date, Tickers, Return, J403, RebalanceTime) %>% 
    rename(weight = J403) %>% 
    mutate(weight = coalesce(weight , 0))
  
# Apply Proportional_Cap_Foo to ALSI to get capped return for cap of 5%

Capped <- RebSWIX %>% 
    group_split(RebalanceTime) %>% 
    map_df(~Proportional_Cap_Foo(., W_Cap = 0.05) ) %>% 
    select(-RebalanceTime)
 
SWIX_wts <- Capped %>% 
    tbl_xts(cols_to_xts = weight, 
            spread_by = Tickers)

SWIX_rts <- ALSI %>% 
    filter(Tickers %in% unique(Capped$Tickers)) %>% 
    tbl_xts(cols_to_xts = Return,
            spread_by = Tickers)

SWIX_wts[is.na(SWIX_wts)] <- 0

SWIX_rts[is.na(SWIX_rts)] <- 0

SWIX_capped <- rmsfuns::Safe_Return.portfolio(R = SWIX_rts, 
                                              weights = SWIX_wts, 
                                              lag_weights = T) %>% 
    xts_tbl() %>% 
    rename(SWIX = portfolio.returns)

# Combine

CapIndex <- left_join(ALSICapped, SWIX_capped, by = "date") %>% 
    pivot_longer(c("ALSI", "SWIX"), 
                 names_to = "Method", 
                 values_to = "returns")

# Uncapped Return - ALSI

ALSI_wts <- ALSI %>% 
filter(date %in% RebDays$date) %>% 
mutate(RebalanceTime = format(date, "%Y%B")) %>% 
    rename(weight = J203) %>% 
    mutate(weight = coalesce(weight , 0)) %>% 
    select(date, Tickers, Return, weight, RebalanceTime) %>% 
     tbl_xts(cols_to_xts = weight, 
             spread_by = Tickers)

ALSI_wts[is.na(ALSI_wts)] <- 0

ALSI_rts[is.na(ALSI_rts)] <- 0

ALSICapped <- rmsfuns::Safe_Return.portfolio(R = ALSI_rts, weights = ALSI_wts, 
    lag_weights = T) %>% 
xts_tbl() %>% 
rename(ALSI = portfolio.returns)

# Uncapped Return - SWIX
 
SWIX_wts <- ALSI %>% 
filter(date %in% RebDays$date) %>% 
mutate(RebalanceTime = format(date, "%Y%B")) %>% 
    rename(weight = J403) %>% 
    mutate(weight = coalesce(weight , 0)) %>% 
    select(date, Tickers, Return, weight, RebalanceTime) %>% 
     tbl_xts(cols_to_xts = weight, spread_by = Tickers)

SWIX_wts[is.na(SWIX_wts)] <- 0

SWIX_rts[is.na(SWIX_rts)] <- 0

SWIX_capped <- rmsfuns::Safe_Return.portfolio(R = SWIX_rts, 
                                              weights = SWIX_wts, 
                                              lag_weights = T) %>% 
    xts_tbl() %>% 
    rename(SWIX = portfolio.returns)

# Plot

AlsiSwix <- left_join(ALSICapped, 
                      SWIX_capped, by = "date") %>% 
    pivot_longer(c("ALSI", "SWIX"), 
                 names_to = "Method", 
                 values_to = "Returns")

```

```{r Capped GGplot creation}

g1 <- CapIndex %>% 
    group_by(Method) %>%
    mutate(Idx = cumprod(1 + returns)) %>% 

     ggplot() + 
    
    geom_rect(data = HV1, 
              aes(xmin = xmin, 
                  xmax = xmax, 
                  ymin = ymin, 
                  ymax = ymax), 
              fill = "red4", 
              alpha = alpha) +
    geom_rect(data = HV2, 
              aes(xmin = xmin, 
                  xmax = xmax, 
                  ymin = ymin, 
                  ymax = ymax), 
              fill = "red4", 
              alpha = alpha) +
    geom_rect(data = HV3, 
              aes(xmin = xmin, 
                  xmax = xmax, 
                  ymin = ymin, 
                  ymax = ymax), 
              fill = "red4", 
              alpha = alpha) +
    geom_rect(data = HV4, 
              aes(xmin = xmin, 
                  xmax = xmax, 
                  ymin = ymin, 
                  ymax = ymax), 
              fill = "red4", 
              alpha = alpha) +
    geom_rect(data = LV1, 
              aes(xmin = xmin, 
                  xmax = xmax, 
                  ymin = ymin, 
                  ymax = ymax), 
              fill = "green4", 
              alpha = alpha) +
    geom_rect(data = LV2, 
              aes(xmin = xmin, 
                  xmax = xmax, 
                  ymin = ymin, 
                  ymax = ymax), 
              fill = "green4", 
              alpha = alpha) +
    geom_rect(data = LV3, 
              aes(xmin = xmin, 
                  xmax = xmax, 
                  ymin = ymin, 
                  ymax = ymax), 
              fill = "green4", 
              alpha = alpha) +
    geom_rect(data = LV4, 
              aes(xmin = xmin, 
                  xmax = xmax, 
                  ymin = ymin, 
                  ymax = ymax), 
              fill = "green4", 
              alpha = alpha) +
    
geom_line(aes(date, 
              Idx, 
              colour = Method), 
          alpha = 0.9) + 
labs(subtitle = "ALSI (10%) & SWIX (6%)", 
     x = "", 
     y = "") + 
    fmx_cols() + 
fmxdat::theme_fmx(subtitle.size = ggpts(20))

g2 <- AlsiSwix %>% 
    group_by(Method) %>%
    mutate(Idx = cumprod(1 + Returns)) %>% 

     ggplot() + 
    
    geom_rect(data = HV1, 
              aes(xmin = xmin, 
                  xmax = xmax, 
                  ymin = ymin, 
                  ymax = ymax), 
              fill = "red4", 
              alpha = alpha) +
    geom_rect(data = HV2, 
              aes(xmin = xmin, 
                  xmax = xmax, 
                  ymin = ymin, 
                  ymax = ymax), 
              fill = "red4", 
              alpha = alpha) +
    geom_rect(data = HV3, 
              aes(xmin = xmin, 
                  xmax = xmax, 
                  ymin = ymin, 
                  ymax = ymax), 
              fill = "red4", 
              alpha = alpha) +
    geom_rect(data = HV4, 
              aes(xmin = xmin, 
                  xmax = xmax, 
                  ymin = ymin, 
                  ymax = ymax), 
              fill = "red4", 
              alpha = alpha) +
    geom_rect(data = LV1, 
              aes(xmin = xmin, 
                  xmax = xmax, 
                  ymin = ymin, 
                  ymax = ymax), 
              fill = "green4", 
              alpha = alpha) +
    geom_rect(data = LV2, 
              aes(xmin = xmin, 
                  xmax = xmax, 
                  ymin = ymin, 
                  ymax = ymax), 
              fill = "green4", 
              alpha = alpha) +
    geom_rect(data = LV3, 
              aes(xmin = xmin, 
                  xmax = xmax, 
                  ymin = ymin, 
                  ymax = ymax), 
              fill = "green4", 
              alpha = alpha) +
    geom_rect(data = LV4, 
              aes(xmin = xmin, 
                  xmax = xmax, 
                  ymin = ymin, 
                  ymax = ymax), 
              fill = "green4", 
              alpha = alpha) +
    
geom_line(aes(date, Idx, colour = Method), alpha = 0.9) + 
labs(subtitle = "Uncapped (ALSI & SWIX)", 
     x = "", 
     y = "") + 
    fmx_cols() + 
fmxdat::theme_fmx(subtitle.size = ggpts(20))

```

```{r ,  warning =  FALSE, fig.align = 'center', fig.cap = " \\label{Figure3.4}", fig.ext = 'png', fig.height = 3, fig.width = 6}

grid.arrange(finplot(g1), 
             finplot(g2))

```

# Data 

```{r Figure1,  warning =  FALSE, fig.align = 'center', fig.cap = "Caption Here \\label{Figure1}", fig.ext = 'png', fig.height = 3, fig.width = 6}


```

